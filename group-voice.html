<!DOCTYPE html>
<html>
<head>
  <title>üéôÔ∏è Group Voice Recorder</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="supabase.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #recordingsList audio {
      display: block;
      margin-top: 15px;
      width: 100%;
    }
    .btn {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
    }
    iframe {
      width: 100%;
      height: 230px;
      border: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>üéôÔ∏è Record & Send Group Voice Message</h2>

  <input type="text" id="group_id" placeholder="Enter Group ID" />
  <br><br>

  <button id="recordBtn" class="btn">üé§ Start Recording</button>
  <button id="stopBtn" class="btn" disabled>‚èπÔ∏è Stop</button>

  <div id="recordingsList"></div>

  <!-- ‚úÖ Emoji Picker -->
  <iframe src="emoji-picker/emoji-picker.html"></iframe>

  <script>
    let currentUser;
    let mediaRecorder;
    let audioChunks = [];

    async function init() {
      const user = supabase.auth.user();
      if (!user) {
        alert('Login required');
        return;
      }
      currentUser = user;
    }
    init();

    document.getElementById('recordBtn').addEventListener('click', async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => uploadVoice(new Blob(audioChunks, { type: 'audio/webm' }));

      mediaRecorder.start();
      document.getElementById('recordBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (mediaRecorder) mediaRecorder.stop();
      document.getElementById('recordBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    });

    async function uploadVoice(blob) {
      const groupId = document.getElementById('group_id').value;
      if (!groupId) return alert('Enter Group ID');

      const fileName = `voice-${Date.now()}.webm`;
      const filePath = `groups/${groupId}/voice/${fileName}`;

      const { error: uploadError } = await supabase.storage
        .from('group-media')
        .upload(filePath, blob);

      if (uploadError) return alert('‚ùå Upload failed');

      const fileURL = supabase.storage.from('group-media').getPublicUrl(filePath).publicURL;

      const { error: dbError } = await supabase
        .from('group_chats')
        .insert([{
          group_id: groupId,
          sender_id: currentUser.id,
          type: 'voice',
          content: fileURL,
          delivered: false,
          seen: false,
          timestamp: new Date().toISOString()
        }]);

      if (dbError) return alert('‚ùå DB insert failed');

      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = fileURL;
      document.getElementById('recordingsList').appendChild(audio);

      alert('‚úÖ Voice sent!');
    }
  </script>
</body>
</html>
